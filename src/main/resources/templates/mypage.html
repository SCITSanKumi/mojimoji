<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>mojimoji</title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bootstrap (예시) -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <script defer th:src="@{/js/bootstrap.bundle.min.js}"></script>

    <!-- jQuery (예시) -->
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>

    <!-- 스타일 -->
    <style>
        /* ============ 헤더 영역 ============ */
        .header-row {
            display: flex;
            /* 가로 배치 */
            justify-content: space-between;
            align-items: center;
            /* 세로 가운데 정렬 */
            margin: 0 50px;
            /* 좌우 여백 */
        }

        .header-row h5 {
            margin: 0;
            /* 기본 마진 제거 */
        }

        .user-info {
            text-align: right;
        }

        /* ============ 게이지 차트 (JLPT 통계) ============ */
        .Collection {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            justify-content: center;
            box-sizing: border-box;
            font-family: sans-serif;
        }

        .chart-container {
            width: 180px;
            margin: -40px 19px 0 8px;
            /* 차트 간 간격/위치 조정 */
            position: relative;
            padding: 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* "전체" 차트만 크게 보이도록 */
        .chart-container.large-chart {
            width: 250px;
            height: 250px;
        }

        /* ============ Bar 차트 영역 ============ */
        .bar-chart-row {
            display: flex;
            width: 900px;
            justify-content: space-between;
            margin: 0 10px;
            /* 상단 제목/일일평균 컨테이너 여백 */
        }

        .bar-chart-wrapper {
            width: 900px;
            margin: 0 10px;
            /* Bar 차트 자체 컨테이너 여백 */
        }

        /* ============ 카테고리 & 한자 목록 ============ */
        .bar-and-category-wrapper {
            display: flex;
            /* Bar 차트와 카테고리 목록을 가로 배치 */
        }

        .category-scroll-container {
            width: 580px;
            margin: -34px 10px 0 5px;
            overflow: scroll;
            height: 500px;
        }

        .category-header-row {
            margin: 2px;
            display: flex;
        }

        .category-sort-icon {
            height: 30px;
            margin: -3px 10px 0 45px;
        }

        .category-achievement-text {
            margin: 0 0 0 185px;
        }

        /* ============ 카테고리 블록 (가로 한 줄 배치) ============ */
        .category-block {
            border: 1px solid #ccc;
            margin-bottom: 20px;
            padding: 10px;
            display: flex;
            /* 가로로 배치 */
            align-items: center;
            /* 세로 중앙 정렬 */
            gap: 20px;
            /* 항목 간 간격 */
        }

        /* 카테고리 정보 부분 */
        .category-info {
            display: flex;
            width: 70px;
            align-items: center;
            /* 세로 중앙 정렬 */
            gap: 10px;
            margin-bottom: 0;
            /* 아래쪽 여백 제거 */
            flex-direction: column;
        }

        /* 한자 목록을 수평 스크롤로 가로 정렬 */
        .horizontal-container {
            display: flex;
            gap: 10px;
            /* 버튼과 리스트 간의 간격 */
            align-items: center;
            /* 수직 중앙 정렬 */
            flex: 3;
            /* 리스트 부분이 더 많은 공간을 차지하도록 */
        }

        /* 한자 목록 (가로 정렬) */
        .horizontal-list {
            list-style: none;
            display: flex;
            gap: 10px;
            /* 한자 간의 간격 */
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 75%;
        }

        /* 한자 항목 */
        .horizontal-list li {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
            min-width: 50px;
        }

        /* 한자 박스 */
        .kanji-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 40px;
        }

        /* 페이지 네비게이션 버튼 */
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 버튼 스타일 */
        .prev-btn,
        .next-btn {
            width: 30px;
            height: 30px;
            cursor: pointer;
            background-color: white;
            border: white;
        }

        /* 수집 여부 표시 */
        .kanji-collected {
            border-radius: 10px;
            color: black;
            font-weight: bold;
        }

        .kanji-not-collected {
            border-radius: 10px;
            color: #999;
            background-color: lightgray;
        }

        /* Progress Bar 컨테이너 */
        .progress-bar-container {
            width: 100px;
            margin: 10px 0;
            text-align: center;
            /* 가운데 정렬 */
        }

        progress {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            /* 사용자 정의 속성 --progress-color를 초기값으로 설정 */
            --progress-color: #4caf50;
        }

        progress::-webkit-progress-bar {
            background-color: #e0e0e0;
            border-radius: 10px;
        }

        progress::-webkit-progress-value {
            background-color: var(--progress-color);
            border-radius: 10px;
        }
    </style>

    <script th:inline="javascript">
        // ---------------------------------------------
        // 1) JLPT 통계 (게이지 차트)
        // ---------------------------------------------
        const statsData = /*[[${stats}]]*/[];  // [{jlptRank:'전체', collected:123},...]
        const rankTotals = {
            "전체": 2136,
            "N1": 1139,
            "N2": 710,
            "N3": 182,
            "N4": 76,
            "N5": 29
        };

        const centerTextPlugin = {
            id: 'centerTextPlugin',
            afterDraw(chart) {
                const opts = chart.config.options.plugins.centerTextPlugin || {};
                const partial = opts.partial || 0;
                const total = opts.total || 1;
                const label = opts.label || 'ALL';

                const percentage = Math.floor((partial / total) * 100);
                const { ctx, chartArea: { top, left, width, height } } = chart;
                const centerX = left + width / 2;
                const centerY = top + height / 2;

                ctx.save();
                ctx.textAlign = 'center';
                ctx.fillStyle = '#333';

                ctx.font = '16px sans-serif';
                ctx.fillText(label, centerX, centerY - 20);

                ctx.font = '16px sans-serif';
                ctx.fillText(`${partial}/${total}`, centerX, centerY + 20);

                ctx.font = '23px sans-serif';
                ctx.fillText(`${percentage}%`, centerX, centerY + 50);

                ctx.restore();
            }
        };

        function createGaugeChart(canvasId, partial, total, label) {
            const percentage = Math.floor((partial / total) * 100);
            const remainValue = 100 - percentage;

            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remainValue],
                        backgroundColor: ['#EE697D', '#ddd'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    rotation: -150,
                    circumference: 300,
                    plugins: {
                        centerTextPlugin: {
                            partial: partial,
                            total: total,
                            label: label
                        },
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: false,
                        onComplete: (anim) => {
                            anim.chart.config.options.animation = false;
                        }
                    }
                },
                plugins: [centerTextPlugin]
            });
        }

        // ---------------------------------------------
        // 2) 날짜별 Bar 차트
        // ---------------------------------------------
        const dailyStatsData = /*[[${dailyStats}]]*/[]; // [{acquisitionDate:'2025-03-01', dailyCount:2}, ...]
        const chartLabels = dailyStatsData.map(ds => ds.acquisitionDate);
        const chartValues = dailyStatsData.map(ds => ds.dailyCount);

        document.addEventListener('DOMContentLoaded', () => {
            // 1) JLPT 게이지 차트들
            statsData.forEach(stat => {
                const rank = stat.jlptRank;
                const collected = stat.collected;
                const total = rankTotals[rank] || 0;
                const canvasId = 'gaugeChart' + rank;
                createGaugeChart(canvasId, collected, total, rank);
            });

            // 2) Bar 차트 생성
            const ctxBar = document.getElementById('lineChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '일자별 획득 한자 수',
                        data: chartValues,
                        backgroundColor: '#EE697D',
                        borderColor: '#EE697D',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        title: {
                            display: false
                        }
                    }
                }
            });
        });

        // ---------------------------------------------
        // 3) 카테고리별 한자 목록 (수평 페이지네이션)
        // ---------------------------------------------
        document.addEventListener('DOMContentLoaded', function () {
            const ITEMS_PER_PAGE = 5;

            // 모든 카테고리 블록을 순회
            document.querySelectorAll('.horizontal-container').forEach(container => {
                const ul = container.querySelector('ul.horizontal-list');
                const liArray = Array.from(ul.querySelectorAll('li'));

                const prevBtn = container.querySelector('.prev-btn');
                const nextBtn = container.querySelector('.next-btn');

                let currentPage = 0;
                const totalPages = Math.ceil(liArray.length / ITEMS_PER_PAGE);

                function renderPage(page) {
                    if (page < 0) page = 0;
                    if (page >= totalPages) page = totalPages - 1;
                    currentPage = page;

                    liArray.forEach(li => li.style.display = 'none');

                    const start = currentPage * ITEMS_PER_PAGE;
                    const end = start + ITEMS_PER_PAGE;
                    liArray.slice(start, end).forEach(li => li.style.display = 'block');
                }

                // 초기 렌더
                renderPage(0);

                // Prev
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 0) {
                        renderPage(currentPage - 1);
                    }
                });
                // Next
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages - 1) {
                        renderPage(currentPage + 1);
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            // 모든 프로그레스 바와 텍스트 요소를 한 번에 선택
            const progressData = []; // { progressBar, progressText, targetValue, startTime }
            document.querySelectorAll('.progress-bar-container').forEach(container => {
                const progressBar = container.querySelector('progress');
                const progressText = container.querySelector('.progress-text');
                // 서버에서 전달된 실제 value를 targetValue로 저장 (예: 습득한 항목 수)
                const serverValue = parseFloat(progressBar.value);
                const targetValue = serverValue;
                // 초기 애니메이션을 위해 value를 0으로 초기화
                progressBar.value = 0;
                progressText.textContent = '0%';
                progressData.push({
                    progressBar,
                    progressText,
                    targetValue,
                    startTime: performance.now()
                });
            });

            const duration = 2500; // 애니메이션 지속 시간 (예: 2.5초)

            function updateAllProgressBars() {
                const currentTime = performance.now();
                let allCompleted = true;

                progressData.forEach(item => {
                    const elapsedTime = currentTime - item.startTime;
                    const progress = Math.min(elapsedTime / duration, 1);
                    // 0부터 targetValue까지 애니메이션 (targetValue는 서버에서 받은 값)
                    const currentValue = progress * item.targetValue;
                    item.progressBar.value = currentValue;

                    // 퍼센트는 전체 max (즉, 총 항목 수)를 기준으로 계산
                    const percentage = item.progressBar.max > 0 ? Math.floor((currentValue / item.progressBar.max) * 100) : 0;
                    item.progressText.textContent = `${percentage}%`;

                    // 5개 색상 구간 (0~20%, 21~40%, 41~60%, 61~80%, 81~100%)
                    if (percentage <= 20) {
                        item.progressBar.style.setProperty('--progress-color', '#F0C9D8');
                    } else if (percentage <= 40) {
                        item.progressBar.style.setProperty('--progress-color', '#EE697D');
                    } else if (percentage <= 60) {
                        item.progressBar.style.setProperty('--progress-color', '#EFA69A');
                    } else if (percentage <= 80) {
                        item.progressBar.style.setProperty('--progress-color', '#727B98');
                    } else {
                        item.progressBar.style.setProperty('--progress-color', '#42405C');
                    }

                    if (progress < 1) {
                        allCompleted = false;
                    }
                });

                if (!allCompleted) {
                    requestAnimationFrame(updateAllProgressBars);
                }
            }

            updateAllProgressBars();
        });

    </script>
</head>

<body>
    <!-- 헤더(네비게이션) -->
    <header class="fixed-top" th:insert="~{fragments/header :: header}"></header>
    <br><br><br><br>

    <!-- 상단: 수집현황 + 사용자 정보 -->
    <div class="header-row">
        <h5>수집현황</h5>
        <div class="user-info">
            <h5 sec:authentication="principal.nickname"></h5>
            <a th:href="@{/board/myStory/list}" style="text-decoration: none;">
                작성한 스토리 : 329개
            </a>
        </div>
    </div>

    <!-- 게이지 차트 (JLPT) -->
    <div class="Collection">
        <th:block th:each="stat : ${stats}">
            <div class="chart-container" th:classappend="${stat.jlptRank} == '전체' ? ' large-chart' : ''">
                <canvas th:id="'gaugeChart' + ${stat.jlptRank}"></canvas>
            </div>
        </th:block>
    </div>

    <div class="d-flex align-items-center my-3">
        <hr class="flex-grow-1">
    </div>

    <!-- 날짜별 Bar 차트 제목 + 일일평균 -->
    <div class="bar-chart-row">
        <h5>날짜별 등록된 한자</h5>
        <h5 th:text="'일일평균: ' + ${dailyAvg} + '개'">일일평균: 0개</h5>
    </div>

    <!-- Bar 차트 + 카테고리 목록을 가로 배치 -->
    <div class="bar-and-category-wrapper">
        <!-- Bar 차트 -->
        <div class="bar-chart-wrapper">
            <canvas id="lineChart"></canvas>
        </div>

        <!-- 카테고리 목록 스크롤 영역 -->
        <div class="category-scroll-container">
            <!-- 카테고리 헤더 (정렬 아이콘 등) -->
            <div class="category-header-row">
                <h5>카테고리</h5>
                <a href="#">
                    <img class="category-sort-icon"
                        src="https://cdn0.iconfinder.com/data/icons/phosphor-regular-vol-4/256/sort-ascending-1024.png"
                        alt="정렬아이콘">
                </a>
                <h5>달성률순</h5>
                <h5 class="category-achievement-text"
                    th:text="'달성 ' + ${summary.fullyCollectedCategoryCount} + '/' + ${summary.totalCategoryCount}">
                    달성 3/104
                </h5>
            </div>

            <!-- Map<String, List<CategoryKanjiRow>> -->
            <!-- key: category, value: List<...> -->
            <th:block th:each="entry : ${catMap}" th:if="${entry.key} != '없음'">
                <div class="category-block">
                    <div class="category-info">
                        <h5 th:text="${entry.key}">카테고리이름</h5>
                        <h5
                            th:text="${#lists.size(entry.value.?[isCollected == 1])} + '/' + ${#lists.size(entry.value)}">
                            0/0
                        </h5>
                    </div>

                    <div class="horizontal-container">
                        <ul class="horizontal-list" th:attr="data-cat=${entry.key}">
                            <div class="pagination-controls">
                                <button type="button" class="prev-btn">&lt;</button>
                                <li th:each="row : ${entry.value}"
                                    th:classappend="${row.isCollected} == 1 ? 'kanji-collected' : 'kanji-not-collected'">
                                    <div class="kanji-box">
                                        <h5 th:text="${row.kanji}">漢</h5>
                                        <h5 th:text="${row.jlptRank}">N1</h5>
                                    </div>
                                    <span th:if="${row.isCollected} == 1"></span>
                                    <span th:if="${row.isCollected} == 0"></span>
                                </li>
                                <button type="button" class="next-btn">&gt;</button>
                            </div>
                        </ul>
                        <div class="progress-bar-container">
                            <progress th:id="'progressBar' + ${entry.key}"
                                th:value="${#lists.size(entry.value.?[isCollected == 1])}"
                                th:max="${#lists.size(entry.value)}">
                            </progress>
                            <div th:id="'progressText' + ${entry.key}" class="progress-text"
                                th:text="${#lists.size(entry.value) > 0 ? ((#lists.size(entry.value.?[isCollected == 1]) * 100) / #lists.size(entry.value)) + '%' : '0%'}">
                                0%
                            </div>
                        </div>
                    </div>
                </div>
            </th:block>

        </div>
    </div>

    <!-- 푸터 -->
    <footer th:insert="~{fragments/footer :: footer}"></footer>
</body>

</html>