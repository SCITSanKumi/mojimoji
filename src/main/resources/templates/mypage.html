<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>mojimoji</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap (예시) -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <script defer th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <!-- jQuery (예시) -->
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>

    <style>
        .Collection {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            box-sizing: border-box;
        }

        .chart-container {
            width: 150px;
            margin: 20px;
            position: relative;
            padding: 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Bar 차트 캔버스 감싸는 div에 폭 1000px 설정 */
        .bar-chart-wrapper {
            width: 1000px;
        }
    </style>

    <script th:inline="javascript">
        // ---------------------------------------------
        // 1) JLPT 통계 (게이지 차트) 관련 스크립트
        // ---------------------------------------------
        const statsData = /*[[${stats}]]*/[];
        const rankTotals = {
            "전체": 2136,
            "N1": 1139,
            "N2": 710,
            "N3": 182,
            "N4": 76,
            "N5": 29
        };

        const centerTextPlugin = {
            id: 'centerTextPlugin',
            afterDraw(chart) {
                const opts = chart.config.options.plugins.centerTextPlugin || {};
                const partial = opts.partial || 0;
                const total = opts.total || 1;
                const label = opts.label || 'ALL';

                const percentage = Math.floor((partial / total) * 100);
                const { ctx, chartArea: { top, left, width, height } } = chart;
                const centerX = left + width / 2;
                const centerY = top + height / 2;

                ctx.save();
                ctx.textAlign = 'center';
                ctx.fillStyle = '#333';

                ctx.font = '16px sans-serif';
                ctx.fillText(label, centerX, centerY - 20);

                ctx.font = '16px sans-serif';
                ctx.fillText(`${partial}/${total}`, centerX, centerY + 20);

                ctx.font = '23px sans-serif';
                ctx.fillText(`${percentage}%`, centerX, centerY + 50);

                ctx.restore();
            }
        };

        function createGaugeChart(canvasId, partial, total, label) {
            const percentage = Math.floor((partial / total) * 100);
            const remainValue = 100 - percentage;

            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [percentage, remainValue],
                        backgroundColor: ['#EE697D', '#ddd'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    rotation: -150,
                    circumference: 300,
                    plugins: {
                        centerTextPlugin: {
                            partial: partial,
                            total: total,
                            label: label
                        },
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: false,
                        onComplete: (anim) => {
                            anim.chart.config.options.animation = false;
                        }
                    }
                },
                plugins: [centerTextPlugin]
            });
        }

        // ---------------------------------------------
        // 2) 날짜별 Bar 차트 (dailyStats)
        // ---------------------------------------------
        const dailyStatsData = /*[[${dailyStats}]]*/[];
        const chartLabels = dailyStatsData.map(ds => ds.acquisitionDate);
        const chartValues = dailyStatsData.map(ds => ds.dailyCount);

        document.addEventListener('DOMContentLoaded', () => {
            // 1) JLPT 차트 생성
            statsData.forEach(stat => {
                const rank = stat.jlptRank;
                const collected = stat.collected;
                const total = rankTotals[rank] || 0;
                const canvasId = 'gaugeChart' + rank;
                createGaugeChart(canvasId, collected, total, rank);
            });

            // 2) Bar 차트 생성
            const ctxBar = document.getElementById('lineChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '일자별 획득 한자 수',
                        data: chartValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        title: {
                            display: false
                        }
                    }
                }
            });
        });
    </script>
</head>

<body>
    <header class="fixed-top" th:insert="~{fragments/header :: header}"></header>
    <br><br><br><br>

    <!-- 수집현황 (게이지 차트들) -->
    <h5>수집현황</h5>
    <div class="Collection">
        <th:block th:each="stat : ${stats}">
            <div class="chart-container">
                <!-- 등급에 따라 id 동적으로 -->
                <canvas th:id="'gaugeChart' + ${stat.jlptRank}"></canvas>
            </div>
        </th:block>
        <div style="width: 200px; height: 200px; float: right;">
            <span sec:authentication="principal.nickname"></span>
            <p>최종접속일 : 2025/02/06</p>
            <a th:href="@{/board/myStory/list}" style="text-decoration: none;">작성한 스토리 : 329개</a>
        </div>
    </div>

    <div class="d-flex align-items-center my-3">
        <hr class="flex-grow-1">
    </div>

    <!-- 날짜별 Bar 차트 -->
    <h5>날짜별 등록된 한자 </h5>
    <div class="bar-chart-wrapper">
        <canvas id="lineChart"></canvas>
    </div>

</body>

</html>