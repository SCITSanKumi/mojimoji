<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mojimoji</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
    <script defer src="../static/js/bootstrap.bundle.min.js" th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <!-- JQuery -->
    <script src="../../static/js/jquery-3.7.1.min.js" th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <style>
        .Collection {

            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            /* 여러 개의 차트를 행/열로 배치 */
            box-sizing: border-box;
        }

        .chart-container {

            width: 150px;
            /* 각 차트 컨테이너 너비 */
            margin: 20px;
            position: relative;
            /* 중앙 텍스트 절대 배치 가능 */
            padding: 10px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
    </style>

    <script th:inline="javascript">

        // 1) 스프링에서 넘어온 stats를 자바스크립트 배열로 받기
        //    (타임리프의 JSON 직렬화를 가정)
        const statsData = /*[[${stats}]]*/[];

        // 2) 등급별 "전체 한자 개수" (예시)
        const rankTotals = {
            "전체": 2136,
            "N1": 1139,
            "N2": 710,
            "N3": 182,
            "N4": 76,
            "N5": 29
        };

        // 3) 커스텀 플러그인 (중앙 텍스트)
        const centerTextPlugin = {
            id: 'centerTextPlugin',
            afterDraw(chart) {
                const opts = chart.config.options.plugins.centerTextPlugin || {};
                const partial = opts.partial || 0;
                const total = opts.total || 1;
                const label = opts.label || 'ALL';

                const percentage = Math.floor((partial / total) * 100);

                const { ctx, chartArea: { top, left, width, height } } = chart;
                const centerX = left + width / 2;
                const centerY = top + height / 2;

                // 그릴 텍스트
                const textLine1 = `${label}`;
                const textLine2 = `${partial}/${total}`;
                const textLine3 = `${percentage}%`;

                ctx.save();
                ctx.textAlign = 'center';
                ctx.fillStyle = '#333';

                ctx.font = '16px sans-serif';
                ctx.fillText(textLine1, centerX, centerY - 20);

                ctx.font = '16px sans-serif';
                ctx.fillText(textLine2, centerX, centerY + 20);

                ctx.font = '23px sans-serif';
                ctx.fillText(textLine3, centerX, centerY + 50);

                ctx.restore();
            }
        };

        // 4) 게이지 차트 생성 함수
        function createGaugeChart(canvasId, partial, total, label) {
            const percentage = Math.floor((partial / total) * 100);
            const remainValue = 100 - percentage;

            const ctx = document.getElementById(canvasId).getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [
                        {
                            data: [percentage, remainValue],
                            backgroundColor: ['#EE697D', '#ddd'],
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    cutout: '70%',
                    rotation: -150,
                    circumference: 300,
                    plugins: {
                        centerTextPlugin: {
                            partial: partial,
                            total: total,
                            label: label
                        },
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: false,
                        onComplete: (anim) => {
                            anim.chart.config.options.animation = false;
                        }
                    }
                },
                plugins: [centerTextPlugin]
            });
        }

        // 5) 페이지 로딩 후 차트 생성
        document.addEventListener('DOMContentLoaded', () => {

            // statsData를 순회하며 차트 생성
            statsData.forEach(stat => {
                const rank = stat.jlptRank;   // "N1", "N2", ... or "ALL"
                const collected = stat.collected; // 내가 수집한 한자 개수
                const total = rankTotals[rank] || 0; // rankTotals에서 가져옴
                const canvasId = 'gaugeChart' + rank; // 예: gaugeChartN1
                createGaugeChart(canvasId, collected, total, rank);
            });
        });


    </script>
</head>

<body>
    <header class="fixed-top" th:insert="~{fragments/header :: header}"></header>
    <br><br><br><br>
    <div class="Collection">
        <h5 style="height: 30px; ">수집현황</h5>
        <!-- 차트를 담을 컨테이너 (6개) -->
        <th:block th:each="stat : ${stats}">
            <div class="chart-container">
                <!-- id를 등급에 따라 다르게 -->
                <canvas th:id="'gaugeChart' + ${stat.jlptRank}"></canvas>
            </div>
        </th:block>
        <div style=" width: 200px; height: 200px; float: right; ">
            <span sec:authentication="principal.nickname"></span>
            <p>최종접속일 : 2025/02/06</p>
            <a th:href="@{/board/myStory/list}" style="text-decoration: none;">작성한 스토리 : 329개</a>
        </div>
    </div>
    <div class="d-flex align-items-center my-3">
        <hr class="flex-grow-1">
    </div>
</body>

</html>