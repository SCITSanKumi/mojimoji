<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>mojimoji - Streaming Debug</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
    <!-- Bootstrap JS -->
    <script defer src="../../static/js/bootstrap.bundle.min.js" th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <!-- jQuery -->
    <script src="../../static/js/jquery-3.7.1.min.js" th:src="@{/js/jquery-3.7.1.min.js}"></script>

    <style>
        /* 헤더와 본문 겹침 방지 */
        body {
            margin: 0;
            padding-top: 70px;
            background-color: #f8f9fa;
        }

        nav.navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 999;
        }

        .game-container {
            width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 채팅 영역 */
        .chat-container {
            height: 500px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background-color: #0d6efd;
            border-radius: 4px;
        }

        /* 말풍선 공통 */
        .message {
            display: flex;
            flex-direction: column;
            margin: 10px 0;
            width: 100%;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 10px;
            margin-top: 5px;
            word-wrap: break-word;
            white-space: pre-wrap;
            border-radius: 10px;
        }

        /* 나레이션 */
        .naration-message {
            align-items: center;
            text-align: center;
        }

        .naration-content {
            background-color: #adb5bd;
            color: #fff;
            border-radius: 10px;
        }

        /* 플레이어(우측) */
        .player-message {
            align-items: flex-end;
            text-align: right;
        }

        .player-content {
            background-color: #0d6efd;
            color: #fff;
            border-radius: 10px 0 10px 10px;
        }

        /* NPC/기타(좌측) */
        .npc-message {
            align-items: flex-start;
            text-align: left;
        }

        .npc-content {
            background-color: #198754;
            color: #fff;
            border-radius: 0 10px 10px 10px;
        }

        .npc-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            /* 이미지를 원형으로 만듦 */
            object-fit: cover;
            /* 이미지 비율 유지하며 꽉 채움 */
            border: 2px solid #ddd;
            /* 테두리 추가 */
        }

        /* 체력/정신력 표시 */
        .status-label {
            width: 60px;
            text-align: right;
        }
    </style>
    <script defer>
        $(() => {
            let bookId = Number("[[${bookId}]]");
            let isGameEnded = false;

            // 현재 화자/이전 화자
            let currentSpeaker = "naration";
            let previousSpeaker = "";

            // JSON 파싱용 버퍼
            let readingJson = false;
            let jsonBuffer = "";

            // 퀴즈 관련 변수
            let questionList = [];
            let currentIndex = 0;
            let correctAnswerIndexes = [];
            let score = 0;

            const chatBox = $("#chatBox");

            // 이벤트 리스너
            $("#submit-btn").click(sendUserMessage);
            $("#userInput").on("keydown", (event) => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    sendUserMessage();
                }
            });

            // 게임 시작
            $("#start-btn").click(() => {
                $.ajax({
                    type: "GET",
                    url: `/game/start/${bookId}`,
                    success: (response) => {
                        bookId = response.bookId;
                        $("#start-btn").addClass("d-none");
                        $(".show-at-game-start").removeClass("d-none");

                        // 첫 안내 문구(json 포함)
                        handleChunkText(response.message);
                    },
                    error: (err) => {
                        console.error("[gameStart] error:", err);
                        alert("게임 시작 중 오류가 발생했습니다.");
                    }
                });
            });

            // 메시지 전송
            function sendUserMessage() {
                let inputField = $("#userInput");
                let inputText = inputField.val().trim();

                if (inputText === "" || bookId === -1) {
                    return;
                }
                // 플레이어 말풍선
                currentSpeaker = "player";
                appendMessage(inputText);
                inputField.val("");

                fetch(`/game/send/${bookId}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: new URLSearchParams({
                            message: inputText
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("메시지 전송 중 오류");
                        }
                        return processResponseStream(response);
                    })
                    .catch(error => {
                        console.error("fetch error:", error);
                        alert(error);
                    });
            }

            /**
             * SSE 응답 처리
             */
            async function processResponseStream(response) {
                const reader = response.body
                    .pipeThrough(new TextDecoderStream())
                    .getReader();

                while (true) {
                    const {
                        done,
                        value
                    } = await reader.read();
                    if (done) {
                        break;
                    }
                    if (!value) {
                        continue;
                    }

                    // data: 제거 + 개행 제거
                    let cleaned = value.replace(/^data:/gm, "").replace(/\r?\n/g, "");
                    if (!cleaned.trim()) {
                        continue;
                    }

                    // 문자 단위로 검사
                    handleChunkText(cleaned);
                }
            }

            /**
             * 문자 단위로 처리해서 '{' ~ '}' 구간을 JSON으로, 그 외는 대사 누적
             */
            function handleChunkText(str) {
                for (let i = 0; i < str.length; i++) {
                    let ch = str[i];

                    if (!readingJson) {
                        // JSON 시작 전
                        if (ch === '{') {
                            readingJson = true;
                            jsonBuffer = "{";
                        } else {
                            // 일반 텍스트
                            appendMessage(ch);
                        }
                    } else {
                        // JSON 읽는 중
                        jsonBuffer += ch;

                        if (ch === '}') {
                            // JSON 완성
                            readingJson = false;
                            parseJson(jsonBuffer);
                            jsonBuffer = "";
                        }
                    }
                }
            }

            /**
             * JSON 문자열을 실제 객체로 파싱
             * {"hp":...} -> 게임정보, {"name":"..."} -> 화자 변경
             */
            function parseJson(jsonStr) {
                try {
                    let parsed = JSON.parse(jsonStr);

                    if (parsed.name !== undefined) {
                        updateSpeaker(parsed);
                    } else if (parsed.hp !== undefined) {
                        updateGameStats(parsed);
                    } else {
                        console.warn("unknown json =>", parsed);
                    }
                } catch (e) {
                    console.error("error =>", e);
                }
            }

            let messageDiv
            let contentDiv

            /**
             * 말풍선 생성
             */
            function appendMessage(text) {
                if (currentSpeaker !== previousSpeaker) {
                    previousSpeaker = currentSpeaker;

                    messageDiv = $("<div>").addClass("message");
                    contentDiv = $("<div>").addClass("message-content");

                    if (currentSpeaker === "naration") {
                        messageDiv.addClass("naration-message");
                        contentDiv.addClass("naration-content");
                    } else if (currentSpeaker === "player") {
                        messageDiv.addClass("player-message");
                        contentDiv.addClass("player-content");
                    } else {
                        let headerDiv = $("<div>").addClass("npc-header");
                        let profileImg = $("<img>")
                            .attr("src", "https://i.namu.wiki/i/8ya30FvrlxJ3M5ymG057r_Xrp7tg_QC65K8mmwLjjKwIo8GbiAFNWNpTH1iwPGhOwRf9Fdpbr0ixrVPK6JoDBRD5_b5aWA0Ex88s8DARnrIKIWX_pXErLW9j71xW5CZW_M4za1O75ZVX4Rv4kfnyhw.webp")
                            .addClass("npc-profile");
                        let nameSpan = $("<span>").text(currentSpeaker).addClass("npc-name");
                        headerDiv.append(profileImg).append(nameSpan);
                        messageDiv.append(headerDiv);

                        messageDiv.addClass("npc-message");
                        contentDiv.addClass("npc-content");
                    }

                    messageDiv.append(contentDiv);
                    $("#chatBox").append(messageDiv);
                }

                contentDiv.append(text);
                scrollToBottom();
            }

            /**
             * 게임 정보 반영
             */
            function updateGameStats(gameState) {
                if (typeof gameState.hp === "number") {
                    $("#healthBar").css("width", gameState.hp + "%").text(gameState.hp);
                }
                if (typeof gameState.mp === "number") {
                    $("#mentalBar").css("width", gameState.mp + "%").text(gameState.mp);
                }
                if (gameState.isEnded) {
                    isGameEnded = true;
                    $("#end-btn").removeClass("d-none");
                }
            }

            /**
             * 화자 정보 반영
             */
            function updateSpeaker(speaker) {
                currentSpeaker = speaker.name;
            }

            function scrollToBottom() {
                requestAnimationFrame(() => {
                    chatBox.scrollTop(chatBox[0].scrollHeight);
                });
            }

            // 마치기 버튼 -> 퀴즈
            $("#end-btn").click(() => {
                if (!isGameEnded) return;

                $.get(`/game/end/${bookId}`, (response) => {
                    console.log(response.title);
                    console.log(response.thumbnailUrl);

                    if (!response || !response.kanjis?.length) {
                        alert("퀴즈 데이터를 불러올 수 없습니다.");
                        return;
                    }
                    questionList = response.kanjis;
                    currentIndex = 0;
                    score = 0;
                    $("#quiz-modal").modal("show");
                    startQuiz();
                }).fail((err) => {
                    console.error("[end-btn] /game/end fail:", err);
                    alert("게임 종료 중 오류");
                });
            });

            // ===== 퀴즈 로직 =====
            function startQuiz() {
                if (currentIndex < questionList.length) {
                    let quizItem = $(".quiz-item");
                    let question = questionList[currentIndex];
                    quizItem.find(".kanji-question").text(`문제: ${question.kanji}`);
                    quizItem.find(".kunyomi-input, .onyomi-input").val("");

                    quizItem.find(".answer-btn").off("click").on("click", () => checkAnswer(question));
                } else {
                    endQuiz();
                }
            }

            function checkAnswer(question) {
                let kunyomiAnswer = $(".kunyomi-input").val().trim();
                let onyomiAnswer = $(".onyomi-input").val().trim();

                if (kunyomiAnswer.toLowerCase() === question.korKunyomi.toLowerCase() &&
                    onyomiAnswer.toLowerCase() === question.korOnyomi.toLowerCase()) {
                    correctAnswerIndexes.push(currentIndex);
                    score++;
                    $.post("/kanji/addCollection", {
                            kanjiId: question.kanjiId
                        })
                        .done(() => {
                            alert("정답! 한자 컬렉션에 추가되었습니다.");
                        })
                        .fail(() => alert("컬렉션 추가 중 오류 발생"));
                } else {
                    alert("오답입니다!");
                }

                currentIndex++;

                if (currentIndex < questionList.length) {
                    startQuiz();
                } else {
                    endQuiz();
                }
            }

            function endQuiz() {
                let resultHtml = questionList.map((q, i) => {
                    let color = correctAnswerIndexes.includes(i) ? "blue" : "red";
                    return `<span style="color:${color}">${q.kanji}</span>`;
                }).join(" ");

                $("#quiz-container").hide();
                $("#game-result").removeClass("d-none").html(`
            <h3 class="text-center">퀴즈 종료!</h3>
            <p><strong>퀴즈 결과:</strong> ${resultHtml}</p>
            <p>맞힌 한자: <strong>${score}</strong>개</p>
            <p>틀린 한자: <strong>${questionList.length - score}</strong>개</p>
            <div class="text-center mt-3">
                <button id="to-main" class="btn btn-primary">메인으로</button>
                <button id="share-story" class="btn btn-secondary">스토리 공유하기</button>
            </div>
            `);

                $("#to-main").off("click").on("click", () => location.href = "/");
                $("#share-story").off("click").on("click", shareStory);
            }

            function shareStory() {
                if (bookId === -1) {
                    alert("게임이 시작되지 않았거나 책 정보가 없습니다.");
                    return;
                }
                $.post("/board/myStory/share", {
                        bookId
                    })
                    .done(() => {
                        alert("스토리가 성공적으로 공유되었습니다!");
                        location.href = "/board/story/list";
                    })
                    .fail(() => {
                        alert("스토리 공유 중 오류가 발생했습니다.");
                    });
            }

            // 모달 강제 종료 방지
            $('#quiz-modal').on('hide.bs.modal', e => {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
        });
    </script>
</head>

<body>
    <header th:insert="~{fragments/header :: header}"></header>

    <div class="game-container">
        <!-- 체력/정신력 등 표시 -->
        <div class="mb-3 w-100 d-flex flex-column align-items-start d-none show-at-game-start">
            <div class="d-flex align-items-center mb-2">
                <span class="status-label me-2">체력</span>
                <div class="progress" style="width: 150px; height: 15px;">
                    <div id="healthBar" class="progress-bar bg-danger" role="progressbar" style="width: 100%">100</div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <span class="status-label me-2">정신력</span>
                <div class="progress" style="width: 150px; height: 15px;">
                    <div id="mentalBar" class="progress-bar bg-primary" role="progressbar" style="width: 100%">100</div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatBox">
            <button class="btn btn-primary position-absolute top-50 start-50 translate-middle" id="start-btn">게임 시작</button>
        </div>

        <!-- 입력창, 종료 버튼 -->
        <div class="input-group mt-3 w-100 d-none show-at-game-start">
            <input type="text" id="userInput" class="form-control" placeholder="입력하세요...">
            <button class="btn btn-primary" id="submit-btn">입력</button>
        </div>
        <button class="btn btn-danger mt-3 d-none" id="end-btn">마치기</button>
    </div>

    <!-- 퀴즈 모달 (게임 종료 후) -->
    <div class="modal fade" id="quiz-modal" tabindex="-1" aria-labelledby="quizModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content p-4">
                <h2 class="text-center">한자 퀴즈</h2>
                <div id="quiz-container">
                    <div class="quiz-item">
                        <h5 class="kanji-question"></h5>
                        <label>한글 훈독</label>
                        <input type="text" class="form-control kunyomi-input">
                        <label>한글 음독</label>
                        <input type="text" class="form-control onyomi-input">
                        <button class="answer-btn btn btn-primary mt-2">제출</button>
                    </div>
                </div>
                <div id="game-result" class="mt-3 d-none"></div>
            </div>
        </div>
    </div>
</body>

</html>