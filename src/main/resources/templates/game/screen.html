<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mojimoji</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
    <!-- Bootstrap Bundle JS -->
    <script defer src="../../static/js/bootstrap.bundle.min.js" th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <!-- jQuery -->
    <script src="../../static/js/jquery-3.7.1.min.js" th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <!-- 한자 리스트 -->
    <script src="../../static/js/kanjiList.js" th:src="@{/js/kanjiList.js}"></script>
    <style>
        #correctKanji {
            color: blue;
        }

        #wrongKanji {
            color: red;
        }

        .modal-content {
            padding: 20px;
            background: #ffffff;
            border-radius: 20px;
        }

        input[type="text"] {
            width: 50px;
        }
    </style>
    <script>
        $(() => {
            let bookId = -1;
            let kanjiList = [];
            let currentQuestionIndex = 0;
            let score = 0;

            $("#start-btn").click(() => {
                $.ajax({
                    type: "GET",
                    url: `/game/start/${bookId}`,
                    success: (response) => {
                        bookId = response.bookId;
                        $("#start-btn").addClass("d-none");
                        $(".dialogue-container, .input-group, #end-btn").removeClass("d-none");
                        $(".dialogue").append(response.message);
                    },
                    error: () => {
                        alert("게임 시작 중 오류가 발생했습니다.");
                    }
                });
            });

            $("#submit-btn").click(sendUserInput);
            $("#userInput").keyup((event) => {
                if (event.key === "Enter") {
                    sendUserInput();
                }
            });

            function sendUserInput() {
                let userText = $("#userInput").val().trim();

                if (bookId !== null) {
                    $("#userInput").val("");

                    fetch(`/game/send/${bookId}`, {
                        method: "POST",
                        headers: {"Content-Type": "application/x-www-form-urlencoded"},
                        body: new URLSearchParams({ message: userText })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("메시지 전송 중 오류가 발생했습니다.");
                        }
                        return response;
                    })
                    .then(streamResponse)
                    .catch(error => {
                        alert(error.message);
                    });
                }
            }

            async function streamResponse(response) {
                const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log("스트리밍 종료");
                        checkGameState(bookId);
                        break;
                    }

                    let cleanedValue = value.replace(/^data:/gm, "").replace(/\n\n/g, "");
                    console.log("서버 응답:", cleanedValue);

                    $(".dialogue-container").removeClass("d-none"); // 숨김 해제
                    $(".dialogue").append(cleanedValue);
                }
            }

            function checkGameState(bookId) {
                $.ajax({
                    url: `/game/state/${bookId}`,
                    type: "GET",
                    success: function (response) {
                        $("#healthDisplay").text(`체력: ${response.health}`);
                        if (response.isEnded) {
                            alert("게임이 종료되었습니다!");
                        }
                    },
                    error: () => {
                        alert("게임 정보 확인 중 오류가 발생했습니다.");
                    }
                });
            }

            $("#end-btn").click(function () {
                $.ajax({
                    url: `/game/end/${bookId}`,
                    type: "GET",
                    success: function (response) {
                        kanjiList = response.kanjis;
                        startQuiz();
                        $("#quiz-modal").removeClass("d-none");
                    },
                    error: () => {
                        alert("게임 종료 중 오류가 발생했습니다.");
                    }
                });

            });

            function startQuiz() {
                if (kanjiList.length > 0) {
                    displayQuestion();
                }
            }

            function displayQuestion() {
                if (currentQuestionIndex < kanjiList.length) {
                    let quizContainer = document.getElementById("quiz-container");
                    let quizItem = quizContainer.querySelector(".quiz-item");
                    let kanjiData = kanjiList[currentQuestionIndex];

                    quizItem.classList.remove("d-none");
                    quizItem.querySelector(".kanji-question").textContent = `문제: ${kanjiData.kanji}`;
                    quizItem.querySelector(".kunyomi-input").value = "";
                    quizItem.querySelector(".onyomi-input").value = "";

                    let answerBtn = quizItem.querySelector(".answer-btn");
                    answerBtn.onclick = function () {
                        checkAnswer(kanjiData);
                    };
                } else {
                    endGame();
                }
            }

            function checkAnswer(kanjiData) {
                let kunyomiInput = document.querySelector(".kunyomi-input").value.trim();
                let onyomiInput = document.querySelector(".onyomi-input").value.trim();

                if (
                    kunyomiInput === kanjiData.korKunyomi.toLowerCase() ||
                    onyomiInput === kanjiData.korOnyomi.toLowerCase()
                ) {
                    score++;
                    alert("정답입니다!");
                } else {
                    alert("오답입니다!");
                }

                document.getElementById("scoreDisplay").textContent = `점수: ${score}`;
                currentQuestionIndex++;
                displayQuestion();
            }

            function endGame() {
                document.getElementById("quiz-container").classList.add("d-none");
                let gameResult = document.getElementById("game-result");
                gameResult.classList.remove("d-none");
                gameResult.innerHTML = `<h3>퀴즈 종료!</h3><p>최종 점수: ${score}</p>`;
            }
        });

        $(function () {
            let currentIndex = 1;
            let totalQuizes = $(".quiz-item").length;
            let correct = 0;
            let correctKanji = '';
            let wrongKanji = '';

            $(".quiz-item").hide();
            $("#quiz" + currentIndex).show();

            $(".answer-btn").click(function () {
                let btnId = $(this).attr("id");
                let id = btnId.replace("btn", "");
                let kanji = $("#kanji-id" + id).data("kanji");

                let kanjiId = $("#kanji-id" + id).val();
                let korKunyomi = $("#kor-kunyomi" + id).val();
                let korOnyomi = $("#kor-onyomi" + id).val();

                if (korKunyomi.trim().length == 0 || korOnyomi.trim().length == 0) {
                    alert("한글훈독과 한글음독을 입력해주세요.");
                    $("#kor-kunyomi" + id).val("");
                    $("#kor-onyomi" + id).val("");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: "/game/quiz",
                    contentType: "application/x-www-form-urlencoded",
                    data: {
                        korKunyomi: korKunyomi,
                        korOnyomi: korOnyomi,
                        kanjiId: kanjiId
                    },
                    success: function (resp) {
                        if (resp) {
                            correct++;
                            correctKanji += `${kanji} `;
                            $(`#${btnId}`).text("정답입니다.");
                            let question = confirm("정답입니다. 컬렉션에 추가하시겠습니까?");
                            $(`#${btnId}`).attr("disabled", true);

                            if (question) {
                                $.ajax({
                                    type: "POST",
                                    url: "/game/addCollection",
                                    contentType: "application/x-www-form-urlencoded",
                                    data: {
                                        kanjiId: kanjiId,
                                        userId: 1
                                    },
                                    success: function (resp) {
                                        if (resp) {
                                            $('#result-text').text("컬렉션에 추가되었습니다.");
                                            nextQuestion();
                                        }
                                    }
                                });
                            } else {
                                $('#result-text').text("컬렉션에 추가하지 않았습니다.");
                                nextQuestion();
                            }
                        } else {
                            $(`#${btnId}`).text("오답입니다.");
                            wrongKanji += `${kanji} `;
                            $('#result-text').text("오답입니다.");
                            nextQuestion();
                        }
                    }
                });
            });

            function nextQuestion() {
                $("#quiz" + currentIndex).hide();
                currentIndex++;

                if (currentIndex <= totalQuizes) {
                    $("#quiz" + currentIndex).show();
                } else {
                    $('#result-text').text("");
                    alert("모든 문제가 끝났습니다.");
                    let wrong = totalQuizes - correct;

                    $('#correct-kanji').html(correctKanji);
                    $('#wrong-kanji').html(correctKanji + wrongKanji + "<br><br>");
                    $('#game-end').html(`맞힌 한자 개수 : ${correct}개 틀린 한자 개수 : ${wrong}개</span><br><br><button id="to-main" class="btn btn-primary">메인으로</button> <button id="to-story-list" class="btn btn-secondary">스토리 공유하기</button>`);
                }

                $("#to-main").click(function () {
                    location.href = "/";
                });
                $("#to-story-list").click(function () {
                    location.href = "/board/story/list";
                });
            }
        });
    </script>
</head>
<body class="bg-light text-center p-3">
    <header class="fixed-top" th:insert="~{fragments/header :: header}"></header>

    <div class="container mt-5">
        <div class="card shadow-lg mx-auto p-3" style="max-width: 600px;">
            <h2 class="text-primary">カミゲ</h2>
            <h4 id="healthDisplay" class="mb-3">체력: 100</h4>

            <div class="story-box border rounded position-relative d-flex align-items-center justify-content-center"
                style="height: 300px; background: url('https://shared.fastly.steamstatic.com/store_item_assets/steam/apps/979461/ss_b6ec5c1b67cafc41fc8ec35e4cbed4bd531a55e1.1920x1080.jpg?t=1729702976') no-repeat center center; background-size: cover;">

`                <button class="btn btn-primary position-absolute top-50 start-50 translate-middle" id="start-btn">
                    게임 시작
                </button>

                <div class="dialogue-container bg-dark text-white p-2 rounded w-100 position-absolute bottom-0 start-0 d-none overflow-auto" style="max-height: 300px;">
                    <p class="dialogue m-0 text-start"></p>
                </div>
            </div>

            <div class="input-group mt-3 d-none">
                <input type="text" id="userInput" class="form-control" placeholder="다음 대사를 입력하세요...">
                <button class="btn btn-primary input-group-append" id="submit-btn">입력</button>
            </div>

            <button class="btn btn-danger d-none" id="end-btn">마치기</button>
        </div>
    </div>
    <div class="container mt-5">
        <div class="card shadow-lg mx-auto p-3" style="max-width: 600px;">
            <h2 class="text-primary">한자 퀴즈</h2>
            <h4 id="scoreDisplay" class="mb-3">점수: 0</h4>
            <div id="quiz-container">
                <div class="quiz-item d-none">
                    <h5 class="kanji-question"></h5>
                    <label>한글 훈독</label>
                    <input type="text" class="form-control kunyomi-input">
                    <label>한글 음독</label>
                    <input type="text" class="form-control onyomi-input">
                    <button class="answer-btn btn btn-primary mt-2">제출</button>
                </div>
            </div>
            <button id="next-btn" class="btn btn-success mt-3 d-none">다음 문제</button>
            <div id="game-result" class="mt-3 d-none"></div>
        </div>
    </div>
</body>
</html>
