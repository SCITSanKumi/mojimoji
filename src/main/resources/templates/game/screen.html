<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mojimoji</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
    <!-- Bootstrap Bundle JS -->
    <script defer src="../../static/js/bootstrap.bundle.min.js" th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <!-- jQuery -->
    <script src="../../static/js/jquery-3.7.1.min.js" th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <!-- 한자 리스트 -->
    <script src="../../static/js/kanjiList.js" th:src="@{/js/kanjiList.js}"></script>
    <script>
        $(() => {
            $("#startGameBtn").click(() => {
                $.ajax({
                    type: "POST",
                    url: "/game/start",
                    contentType: "application/x-www-form-urlencoded",
                    dataType: "json",
                    data: { bookId: -1 },
                    success: (response) => {
                        bookId = response.bookId;
                        $("#startGameBtn").addClass("d-none");
                        $(".dialogue-container, .input-group").removeClass("d-none");
                        $(".dialogue").append(text);
                    },
                    error: () => {
                        alert("게임 시작 중 오류가 발생했습니다.");
                    }
                });
            });

            $("#submitBtn").click(sendUserInput);
            $("#userInput").keyup((event) => {
                if (event.key === "Enter") {
                    sendUserInput();
                }
            });

            function sendUserInput() {
                let userText = $("#userInput").val().trim();

                if (!kanjiList.includes(userText)) {
                    alert("상용한자(常用漢字)만 입력 가능합니다.");
                    return;
                }

                if (bookId !== null) {
                    $("#userInput").val("");

                    fetch("/game/send", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ bookId: bookId, message: userText })
                    })
                    .then(streamResponse);
                }
            }

            async function streamResponse(response) {
                const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log("스트리밍 종료");
                        checkGameState(bookId);
                        break;
                    }

                    let cleanedValue = value.replace(/^data:/gm, "").replace(/\n\n/g, "");
                    console.log("서버 응답:", cleanedValue);

                    $(".dialogue-container").removeClass("d-none"); // 숨김 해제
                    $(".dialogue").append(cleanedValue);
                }
            }

            function checkGameState(bookId) {
                $.ajax({
                    url: `/game/state/${bookId}`,
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        $("#healthDisplay").text(`체력: ${data.health}`);
                        if (data.isEnded) {
                            alert("게임이 종료되었습니다!");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("게임 상태 조회 실패:", error);
                    }
                });
            }
        });
    </script>
</head>
<body class="bg-light text-center p-3">
    <header class="fixed-top" th:insert="~{fragments/header :: header}"></header>

    <div class="container mt-5">
        <div class="card shadow-lg mx-auto p-3" style="max-width: 600px;">
            <h2 class="text-primary">カミゲ</h2>
            <h4 id="healthDisplay" class="mb-3">체력: 100</h4>

            <div class="story-box border rounded position-relative d-flex align-items-center justify-content-center"
                style="height: 300px; background: url('https://shared.fastly.steamstatic.com/store_item_assets/steam/apps/979461/ss_b6ec5c1b67cafc41fc8ec35e4cbed4bd531a55e1.1920x1080.jpg?t=1729702976') no-repeat center center; background-size: cover;">

                <button class="btn btn-primary position-absolute top-50 start-50 translate-middle" id="startGameBtn">
                    게임 시작
                </button>

                <div class="dialogue-container bg-dark text-white p-2 rounded w-100 position-absolute bottom-0 start-0 d-none overflow-auto" style="max-height: 300px;">
                    <p class="dialogue m-0 text-start"></p>
                </div>
            </div>

            <div class="input-group mt-3 d-none">
                <input type="text" id="userInput" class="form-control" placeholder="다음 대사를 입력하세요...">
                <button class="btn btn-primary input-group-append" id="submitBtn">입력</button>
            </div>
        </div>
    </div>
</body>
</html>
