<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>mojimoji</title>
    <link rel="stylesheet" type="text/css" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
    <script defer src="../static/js/bootstrap.bundle.min.js" th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <!-- JQuery -->
    <script src="../../static/js/jquery-3.7.1.min.js" th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: sans-serif;
            position: relative;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .scroll-arrow {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            opacity: 0.5;
            transition: opacity 0.3s;
            cursor: pointer;
            z-index: 3000;
        }

        .scroll-arrow:hover {
            opacity: 1;
        }

        .kanjiCard {
            width: 245px;
            height: 367px;
            border: 1px solid gray;
            text-align: center;
        }

        .notKanjiCard {
            width: 245px;
            height: 367px;
            border: 1px solid gray;
            text-align: center;
            background-color: lightgray;
            opacity: 0.5;
        }

        .kanji {
            font-size: 100px;
            font-weight: bold;
        }

        .kanjiExplain {
            text-align: left;
            font-size: 16px;
            margin-left: 10px;

        }

        .category {
            line-height: 15px;
        }

        .jlptRank {
            line-height: 15px;
            font-weight: bold;
            text-align: left;
            margin-top: 5px;
        }

        .yomi {
            text-align: center;
            font-size: 36px;
            margin-top: 10px;
        }

        .kanjiId {
            margin-top: 50px;
            font-size: 15px;
            color: #1063FE;
            float: left;
        }

        .createdAt {
            margin-top: 50px;
            font-size: 15px;
            float: right;
            margin-right: 10px;
        }

        .border-lv1 {
            border: 3px solid #6A3805 !important;
        }

        .border-lv2 {
            border: 3px solid silver !important;
        }

        .border-lv3 {
            border: 3px solid gold !important;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>
    <header class="fixed-top" th:insert="~{fragments/header :: header}"></header>
    <div class="container px-4 py-5" id="custom-cards"><br><br><br>
        <h2>한자 수집북</h2>
        <span id="kanjiCurrent" th:text="${collected} + '/' + ${totalCount}">0/0</span>

        <!-- 검색 폼 -->
        <form th:action="@{/kanji/collection}" method="get" id="searchForm">
            <select id="kanjiSort" name="kanjiSort">
                <option value="한자번호순" th:selected="${kanjiSort} == '한자번호순'">한자번호순</option>
                <option value="최근등록순" th:selected="${kanjiSort} == '최근등록순'">최근등록순</option>
            </select>
            <select id="sortDirection" name="sortDirection">
                <option value="asc" th:selected="${sortDirection} == 'asc'">오름차순</option>
                <option value="desc" th:selected="${sortDirection} == 'desc'">내림차순</option>
            </select>

            카테고리 :
            <select name="category">
                <option value="" th:selected="${category} == ''">전체</option>
                <option value="가족" th:selected="${category} == '가족'">가족</option>
                <option value="감각" th:selected="${category} == '감각'">감각</option>
                <option value="감정" th:selected="${category} == '감정'">감정</option>
                <option value="국가" th:selected="${category} == '국가'">국가</option>
                <option value="금속" th:selected="${category} == '금속'">금속</option>
                <option value="동물" th:selected="${category} == '동물'">동물</option>
                <option value="문서" th:selected="${category} == '문서'">문서</option>
                <option value="방위" th:selected="${category} == '방위'">방위</option>
                <option value="사계" th:selected="${category} == '사계'">사계</option>
                <option value="사상" th:selected="${category} == '사상'">사상</option>
                <option value="색감" th:selected="${category} == '색감'">색감</option>
                <option value="수계" th:selected="${category} == '수계'">수계</option>
                <option value="수학" th:selected="${category} == '수학'">수학</option>
                <option value="시간" th:selected="${category} == '시간'">시간</option>
                <option value="식물" th:selected="${category} == '식물'">식물</option>
                <option value="신체" th:selected="${category} == '신체'">신체</option>
                <option value="음식" th:selected="${category} == '음식'">음식</option>
                <option value="의류" th:selected="${category} == '의류'">의류</option>
                <option value="인공" th:selected="${category} == '인공'">인공</option>
                <option value="자연" th:selected="${category} == '자연'">자연</option>
                <option value="작용" th:selected="${category} == '작용'">작용</option>
                <option value="장소" th:selected="${category} == '장소'">장소</option>
                <option value="종교" th:selected="${category} == '종교'">종교</option>
                <option value="지칭" th:selected="${category} == '지칭'">지칭</option>
                <option value="직업" th:selected="${category} == '직업'">직업</option>
                <option value="형용사" th:selected="${category} == '형용사'">형용사</option>
            </select>
            급수 :
            <select name="jlptRank">
                <option value="" th:selected="${jlptRank} == ''">전체</option>
                <option value="N1" th:selected="${jlptRank} == 'N1'">N1</option>
                <option value="N2" th:selected="${jlptRank} == 'N2'">N2</option>
                <option value="N3" th:selected="${jlptRank} == 'N3'">N3</option>
                <option value="N4" th:selected="${jlptRank} == 'N4'">N4</option>
                <option value="N5" th:selected="${jlptRank} == 'N5'">N5</option>
            </select>
            <input type="text" name="kanjiSearch" th:value="${kanjiSearch}" placeholder="한자를 입력해주세요">
            <input type="submit" value="검색">
        </form>

        <br><br>

        <!-- 초기 카드 목록(서버 렌더링된 10개) -->
        <div class="grid-container" id="cardContainer">
            <div th:each="kanji : ${myCollection}">
                <div th:if="${kanji.isCollected} == 1" th:class="kanjiCard" th:classappend="
        ${kanji.collectionCount} >= 10 ? ' border-lv3' :
        (${kanji.collectionCount} >= 5 ? ' border-lv2' :
        (${kanji.collectionCount} >= 1 ? ' border-lv1' : ''))
        ">
                    <span class="kanji" th:text="${kanji.kanji}">水</span>
                    <hr>
                    <div class="kanjiExplain">
                        <div class="category">카테고리 : <span th:text="${kanji.category}">?</span></div>
                        <div class="jlptRank" th:text="${kanji.jlptRank}">N5</div>
                        <div class="yomi" th:text="${kanji.KorKunyomi} + ' ' + ${kanji.KorOnyomi}"></div>
                        <div class="kanjiId" th:text="'No.' + ${kanji.KanjiId}">]</div>
                    </div>
                    <div class="createdAt" th:text="${#temporals.format(kanji.firstCollectedAt,'yyyy-MM-dd')}"></div>
                </div>
                <div th:unless="${kanji.isCollected} == 1" th:class="notKanjiCard" th:classappend="
        ${kanji.collectionCount} >= 10 ? ' border-lv3' :
        (${kanji.collectionCount} >= 5 ? ' border-lv2' :
        (${kanji.collectionCount} >= 1 ? ' border-lv1' : ''))
        ">
                    <span class="kanji" th:text="${kanji.kanji}">火</span>
                    <hr>
                    <div class="kanjiExplain">
                        <div class="category">카테고리 : <span th:text="${kanji.category}">?</span></div>
                        <div class="jlptRank" th:text="${kanji.jlptRank}">N5</div>
                        <div class="yomi" th:text="${kanji.KorKunyomi} + ' ' + ${kanji.KorOnyomi}"></div>
                        <div class="kanjiId" th:text="'No.' + ${kanji.KanjiId}">]</div>
                    </div>
                    <div class="createdAt">미등록</div>
                </div>
            </div>
        </div>
    </div>
    <!-- 아래 화살표 -->
    <div class="scroll-arrow" id="scrollArrow">⬇</div>

    <script>
        $(function () {
            let currentPage = 1;
            let hasMore = true;

            $(window).on("scroll", function () {
                if ($(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                    if (hasMore) {
                        loadNextPage();
                    }
                }
                updateArrow();
            });

            $("#scrollArrow").on("click", function () {
                $("html, body").animate({ scrollTop: $(window).scrollTop() + 300 }, 400);
            });

            function updateArrow() {
                if ($(window).scrollTop() + $(window).height() >= $(document).height() - 10) {
                    $("#scrollArrow").hide();
                } else {
                    $("#scrollArrow").show();
                }
            }
            updateArrow();

            function loadNextPage() {
                currentPage++;
                let queryParams = $("#searchForm").serialize();
                queryParams += "&page=" + currentPage;

                $.ajax({
                    url: "/kanji/collectionAjax",
                    method: "GET",
                    data: queryParams,
                    success: function (html) {
                        if ($.trim(html).length < 10) {
                            // 결과가 거의 없으면 더 이상 로드X
                            hasMore = false;
                        }
                        $("#cardContainer").append(html);
                    },
                    error: function () {
                        hasMore = false;
                    }
                });
            }
        });
    </script>

</body>

</html>